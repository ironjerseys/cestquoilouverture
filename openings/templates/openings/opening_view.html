{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C'est quoi l'ouverture</title>
    <!-- Chargement du fichier CSS depuis le dossier des fichiers statiques -->
    <link rel="stylesheet" href="{% static 'openings/styles.css' %}">
</head>
<body>
    <!-- Formulaire pour sélectionner une ouverture -->
    <form id="opening-form" method="POST">
        {% csrf_token %}
        <div id="select-container">
            <select id="opening-select" name="opening_id">
                {% for opening in openings %}
                    <option value="{{ opening.id }}">{{ opening.name }}</option>
                {% endfor %}
            </select>
    
            <select id="variation-select" name="variation_id">
                <option value="">-- Sélectionnez une variante --</option>
            </select>
        </div>
    </form>
    <!-- Conteneur pour afficher le plateau d'échecs -->
    <div id="chess-board"></div>

    <div id="button-container">
        <button type="button" id="prev-move-btn">Précédent</button>
        <button type="button" id="next-move-btn">Suivant</button>
    </div>

    <script>
        // Déclare une variable globale pour suivre l'index actuel de la position
        let currentIndex = 0; // Index actuel de la position

        /**
         * Fonction qui récupère le token CSRF depuis le formulaire HTML.
         * Cela est nécessaire pour les requêtes POST dans Django.
         */
        const getCsrfToken = () => {
            // Sélectionne l'élément HTML caché contenant le token CSRF et retourne sa valeur
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        };

        /**
         * Fonction qui met à jour le plateau d'échecs pour une nouvelle position.
         * @param {number} newIndex - L'index de la position à afficher.
         */
        const updateBoard = async (newIndex) => {
            // Récupère le formulaire HTML et ses données
            const form = document.getElementById('opening-form');
            const formData = new FormData(form);
            // Ajoute l'index de la position au formulaire
            formData.append('position_index', newIndex);

            try {
                // Effectue une requête POST au serveur pour récupérer les données du plateau
                const response = await fetch('', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken() // Ajout du token CSRF
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Parse la réponse JSON
                const data = await response.json();
                if (data.error) {
                    alert('Erreur : ' + data.error);
                } else {
                    // Met à jour le plateau d'échecs et les index
                    document.getElementById('chess-board').innerHTML = data.svg;
                    currentIndex = newIndex;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('Une erreur est survenue. Consultez la console pour plus de détails.');
            }
        };

         /**
         * Trie les options d'un élément <select> par ordre alphabétique.
         * @param {string} selectId - L'ID du <select> à trier.
         */
        function sortSelectOptions(selectId) {
            const selectElement = document.getElementById(selectId);
            // Convertit la liste des options en un tableau
            const options = Array.from(selectElement.options);

            // Trie les options par texte
            options.sort((a, b) => a.text.localeCompare(b.text));

            // Supprime toutes les options existantes
            selectElement.innerHTML = '';

            // Ajoute les options triées
            options.forEach(option => selectElement.add(option));
        }


        /**
         * Gestionnaire pour le bouton "Précédent".
         * Réduit l'index de la position de 1 (minimum 0).
         */
        document.getElementById('prev-move-btn').addEventListener('click', () => {
            updateBoard(Math.max(currentIndex - 1, 0));
        });

        /**
         * Gestionnaire pour le bouton "Suivant".
         * Augmente l'index de la position de 1.
         */
        document.getElementById('next-move-btn').addEventListener('click', () => {
            updateBoard(currentIndex + 1);
        });

        /**
         * Gestionnaire pour le champ déroulant des ouvertures.
         * Réinitialise l'index et met à jour le plateau pour la nouvelle ouverture.
         */
        document.getElementById('opening-select').addEventListener('change', async function () {
            currentIndex = 0;

            const openingId = this.value; // Récupère la valeur sélectionnée

            if (!openingId) {
                alert("Veuillez sélectionner une ouverture.");
                return;
            }

            try {
                // Charge les variantes associées
                const response = await fetch(`/openings/variations/${openingId}/`);
                
                if (!response.ok) {
                    throw new Error(`Erreur lors du chargement des variantes : ${response.status}`);
                }

                const data = await response.json();

                // Met à jour le champ déroulant des variantes
                const variationSelect = document.getElementById('variation-select');
                variationSelect.innerHTML = '<option value="">-- Sélectionnez une variante --</option>';
                data.variations.forEach(variation => {
                    const option = document.createElement('option');
                    option.value = variation.id;
                    option.textContent = variation.name;
                    variationSelect.appendChild(option);
                });

                // Réinitialise et met à jour le plateau pour l'ouverture sélectionnée
                updateBoard(currentIndex);
            } catch (error) {
                console.error("Erreur lors du chargement des variantes :", error);
                alert("Une erreur est survenue lors du chargement des variantes. Consultez la console pour plus de détails.");
            }
        });

        sortSelectOptions('opening-select');
        sortSelectOptions('variation-select');

        // Initialiser l'échiquier avec la première ouverture
        updateBoard(currentIndex);
    </script>
</body>
</html>
